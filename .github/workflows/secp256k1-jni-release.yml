name: secp256k1-jni Release

on:
  push:
    tags:
      - 'secp256k1-jni-v*'
  workflow_dispatch:

jobs:
  build-native:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux_64
          - os: ubuntu-24.04-arm
            platform: linux_arm64
          - os: macos-15-intel
            platform: osx_64
          - os: macos-latest
            platform: osx_arm64
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            trusted-public-keys = hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= iohk.cachix.org-1:DpRUyj7h7V830dp/i6Nti+NEO2/nhblbov/8MW7Rqoo= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
            substituters = https://cache.iog.io https://cache.nixos.org/ https://iohk.cachix.org https://nix-community.cachix.org
            accept-flake-config = true
            allow-import-from-derivation = true
            experimental-features = nix-command flakes

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build native library
        run: |
          nix develop .#ci --accept-flake-config --command bash -c "cd scalus-secp256k1-jni && make"

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.platform }}
          path: scalus-secp256k1-jni/src/main/resources/natives/${{ matrix.platform }}/

  publish:
    needs: build-native
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            trusted-public-keys = hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= iohk.cachix.org-1:DpRUyj7h7V830dp/i6Nti+NEO2/nhblbov/8MW7Rqoo= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
            substituters = https://cache.iog.io https://cache.nixos.org/ https://iohk.cachix.org https://nix-community.cachix.org
            accept-flake-config = true
            allow-import-from-derivation = true
            experimental-features = nix-command flakes

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Download all native libraries
        uses: actions/download-artifact@v4
        with:
          path: scalus-secp256k1-jni/src/main/resources/natives/
          pattern: native-*
          merge-multiple: false

      - name: Organize native libraries
        run: |
          cd scalus-secp256k1-jni/src/main/resources/natives
          for platform in linux_64 linux_arm64 osx_64 osx_arm64; do
            if [ -d "native-$platform" ]; then
              mkdir -p "$platform"
              mv native-$platform/* "$platform/"
              rmdir "native-$platform"
            fi
          done
          find . -type f -name "*.so" -o -name "*.dylib" | head -20

      - name: Compile and package
        run: |
          nix develop .#ci --accept-flake-config --command bash -c "sbt scalus-secp256k1-jni/compile scalus-secp256k1-jni/package"

      - name: Publish to Sonatype
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          nix develop .#ci --accept-flake-config --command bash -c "sbt scalus-secp256k1-jni/ci-release"
        env:
          PGP_PASSPHRASE: ${{ secrets.PGP_PASSPHRASE }}
          PGP_SECRET: ${{ secrets.PGP_SECRET }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
