name: secp256k1-jni Release

on:
  push:
    tags:
      - 'secp256k1-jni-v*'
  workflow_dispatch:

jobs:
  build-native:
    strategy:
      max-parallel: 4
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux_64
          - os: ubuntu-24.04-arm
            platform: linux_arm64
          - os: macos-15-intel
            platform: osx_64
          - os: macos-latest
            platform: osx_arm64
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: nixbuild/nix-quick-install-action@v34

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build native library
        run: |
          nix develop .#ci-secp --accept-flake-config --command bash -c "cd scalus-secp256k1-jni && make"

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.platform }}
          path: scalus-secp256k1-jni/src/main/resources/natives/${{ matrix.platform }}/

  publish:
    needs: build-native
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: nixbuild/nix-quick-install-action@v34

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Download all native libraries
        uses: actions/download-artifact@v4
        with:
          path: scalus-secp256k1-jni/src/main/resources/natives/
          pattern: native-*
          merge-multiple: false

      - name: Organize native libraries
        run: |
          cd scalus-secp256k1-jni/src/main/resources/natives
          for platform in linux_64 linux_arm64 osx_64 osx_arm64; do
            if [ -d "native-$platform" ]; then
              mkdir -p "$platform"
              mv native-$platform/* "$platform/"
              rmdir "native-$platform"
            fi
          done
          find . -type f -name "*.so" -o -name "*.dylib" | head -20

      - name: Compile and package
        run: |
          nix develop .#ci-secp --accept-flake-config --command bash -c "sbt scalus-secp256k1-jni/package"

      - name: Import GPG key
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "$PGP_SECRET" | base64 --decode | gpg --batch --import
        env:
          PGP_SECRET: ${{ secrets.PGP_SECRET }}

      - name: Publish to Sonatype
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          rm -rf target/sona-staging
          nix develop .#ci-secp --accept-flake-config --command bash -c "sbt 'set ThisBuild / isSnapshot := false; scalus-secp256k1-jni/publishSigned; sonaRelease'"
        env:
          PGP_PASSPHRASE: ${{ secrets.PGP_PASSPHRASE }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
